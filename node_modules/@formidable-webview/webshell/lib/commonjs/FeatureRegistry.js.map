{"version":3,"sources":["FeatureRegistry.ts"],"names":["extractFeatureProps","props","propsMap","type","Object","keys","reduce","obj","key","filterWebViewProps","startsWith","getHandlerUUID","identifier","eventId","extractHandlersMap","features","map","f","values","propSpecs","p","c","spec","featureIdentifier","extractPropsSpecsMap","reporter","name","dispatchError","FeatureRegistry","handlersMap","shellHandlerId","handlerName","webShellProps","feature","indexOf"],"mappings":"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","sourcesContent":["import Feature from './Feature';\nimport Reporter from './Reporter';\nimport { PropDefinition, PropsSpecs, WebshellProps } from './types';\n\nfunction extractFeatureProps(\n  props: WebshellProps<any, any>,\n  propsMap: Record<string, PropDefinition<any, any>>,\n  type: 'handler' | 'inert' | null = null\n): any {\n  return Object.keys(props).reduce((obj, key) => {\n    if (propsMap[key] && (type == null || propsMap[key].type === type)) {\n      return {\n        ...obj,\n        [key]: props[key]\n      };\n    }\n    return obj;\n  }, {});\n}\n\nfunction filterWebViewProps<W>(\n  props: WebshellProps<any, any>,\n  propsMap: Record<string, PropDefinition<any, any>>\n): W {\n  return Object.keys(props).reduce((obj, key) => {\n    if (propsMap[key] || key.startsWith('webshell')) {\n      return obj;\n    }\n    return {\n      ...obj,\n      [key]: props[key]\n    };\n  }, {} as W);\n}\n\nfunction getHandlerUUID(identifier: string, eventId: string) {\n  return `${identifier}:${eventId}`;\n}\n\nfunction extractHandlersMap(features: Feature<any, PropsSpecs<any, any>>[]) {\n  return features\n    .map((f: Feature<any, PropsSpecs<any, any>>) => Object.values(f.propSpecs))\n    .reduce((p, c) => [...p, ...c], [])\n    .reduce((map, spec: PropDefinition<any, any>) => {\n      return {\n        ...map,\n        [getHandlerUUID(spec.featureIdentifier, spec.eventId)]: spec\n      };\n    }, {}) as Record<string, PropDefinition<any, any>>;\n}\n\nfunction extractPropsSpecsMap(\n  features: Feature<any, PropsSpecs<any, any>>[],\n  reporter: Reporter\n) {\n  return features\n    .map((f: Feature<any, PropsSpecs<any, any>>) => Object.values(f.propSpecs))\n    .reduce((p, c) => [...p, ...c], [])\n    .reduce((map, spec: PropDefinition<any, any>) => {\n      if (map[spec.name]) {\n        reporter.dispatchError(\n          'WEBSH_DUPLICATED_REGISTERED_PROP',\n          map[spec.name],\n          spec\n        );\n      }\n      return { ...map, [spec.name]: spec };\n    }, {}) as Record<string, PropDefinition<any, any>>;\n}\n\nexport default class FeatureRegistry<F extends Feature<any, any, any>[]> {\n  readonly propsMap: Record<string, PropDefinition<any, any>>;\n  readonly handlersMap: Record<string, PropDefinition<any, any>>;\n  readonly features: F;\n  constructor(features: F, reporter: Reporter) {\n    this.propsMap = extractPropsSpecsMap(features, reporter);\n    this.handlersMap = extractHandlersMap(features);\n    this.features = features;\n  }\n\n  getWebHandlers(props: WebshellProps<any, any>) {\n    return extractFeatureProps(props, this.propsMap, 'handler');\n  }\n\n  getPropDefFromId(identifier: string, shellHandlerId: string) {\n    return this.handlersMap[getHandlerUUID(identifier, shellHandlerId)];\n  }\n\n  getPropDefFromHandlerName(handlerName: string) {\n    return this.propsMap[handlerName];\n  }\n\n  filterWebViewProps<W>(webShellProps: WebshellProps<any, any>) {\n    return filterWebViewProps<W>(webShellProps, this.propsMap);\n  }\n\n  hasFeature(feature: Feature<any, any, any>) {\n    return this.features.indexOf(feature) !== -1;\n  }\n}\n"]}